generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// USER MODEL
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Gehashed met bcrypt
  name          String?
  role          String    @default("BC")
  status        String    @default("ACTIVE")
  
  // MLM Hierarchy
  sponsorId     String?
  sponsor       User?     @relation("Sponsorship", fields: [sponsorId], references: [id])
  downline      User[]    @relation("Sponsorship")
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  leads         Lead[]
  sales         Sale[]
  calls         CallLog[]
  commissions   Commission[]
  queueItems    QueueItem[]
  offers        Offer[]
  
  @@index([sponsorId])
  @@index([email])
  @@index([role])
}

// LEAD MODEL
model Lead {
  id                String   @id @default(cuid())
  
  // Contact info (Encrypted)
  phone             String
  email             String?
  ean               String?
  phoneHash         String   @map("phonehash")
  
  // Business info
  companyName       String   @map("companyname")
  contactName       String?  @map("contactname")
  niche             String?
  address           String?  @map("address")
  city              String?  @map("city")
  province          String?  @map("province")
  postalCode        String?  @map("postalcode")
  
  // Provider info
  currentProvider   String?  @map("currentprovider")
  currentSupplier   String?  @map("currentsupplier")
  
  // GDPR & Consent
  consentEmail      Boolean  @default(false) @map("consentemail")
  consentPhone      Boolean  @default(false) @map("consentphone")
  consentWhatsapp   Boolean  @default(false) @map("consentwhatsapp")
  lawfulBasis       String   @default("LEGITIMATE_INTEREST") @map("lawfulbasis")
  doNotCall         Boolean  @default(false) @map("donotcall")
  gdprAcceptanceDate DateTime? @map("gdpracceptancedate")
  privacyPolicyVersion String? @map("privacypolicyversion")
  
  // Ownership
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id])
  
  // Status
  status            String   @default("NEW")
  source            String?
  
  // Timestamps
  createdAt         DateTime   @default(now()) @map("createdat")
  updatedAt         DateTime   @updatedAt @map("updatedat")
  
  // Relations
  sales             Sale[]
  calls             CallLog[]
  queueItems        QueueItem[]
  offers            Offer[]
  
  @@index([ownerId])
  @@index([status])
  @@index([province])
  @@index([niche])
  @@index([phoneHash])
  @@map("Lead")
}

// SALE MODEL
model Sale {
  id              String   @id @default(cuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  consultantId    String
  consultant      User     @relation(fields: [consultantId], references: [id])
  
  // Product details
  services        Service[]
  
  // Commissie berekening
  totalRetail     Float
  totalASP        Float
  commissionAmount Float
  
  // Status
  status          String   @default("PENDING")
  activationDate  DateTime?
  isNewCustomer   Boolean    @default(false)
  hasPortability  Boolean    @default(false)
  hasConvergence  Boolean    @default(false)
  
  // Policy tracking
  policyVersion   String     @default("2024-Q1")
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([consultantId])
  @@index([leadId])
  @@index([status])
}

model Service {
  id          String  @id @default(cuid())
  saleId      String
  sale        Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  type        String
  plan        String
  retailValue Float
  aspValue    Float
}

// CALL LOG
model CallLog {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  consultantId String
  consultant  User     @relation(fields: [consultantId], references: [id])
  
  result      String
  notes       String?
  duration    Int?
  calledAt    DateTime @default(now())
  
  @@index([leadId])
  @@index([consultantId])
  @@index([calledAt])
}

// QUEUE ITEM
model QueueItem {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  assignedTo  String
  consultant  User     @relation(fields: [assignedTo], references: [id])
  
  priority    Int      @default(0)
  dueDate     DateTime?
  status      String   @default("PENDING")
  type        String   @default("CALL")
  
  createdAt   DateTime    @default(now())
  
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
}

// COMMISSION
model Commission {
  id              String   @id @default(cuid())
  consultantId    String
  consultant      User     @relation(fields: [consultantId], references: [id])
  saleId          String
  amount          Float
  type            String
  status          String   @default("PENDING")
  calculationDate DateTime @default(now())
  paidDate        DateTime?
  
  @@index([consultantId])
  @@index([status])
}

// APPOINTMENTS
model Appointment {
  id              String    @id @default(cuid())
  leadId          String    @map("leadid")
  type            String    // 'PHONE' or 'PHYSICAL'
  appointmentDate String    @map("appointmentdate")
  appointmentTime String    @map("appointmenttime")
  notes           String?
  status          String    @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  googleEventId   String?   @map("googleeventid")  // Voor Google Calendar sync
  createdAt       DateTime  @default(now()) @map("createdat")
  updatedAt       DateTime  @updatedAt @map("updatedat")
  
  @@index([leadId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

// OFFER MODEL
model Offer {
  id              String   @id @default(cuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  consultantId    String
  consultant      User     @relation(fields: [consultantId], references: [id])
  
  // Offer details
  products        Json     // Array of {type, plan, retailValue, aspValue}
  totalRetail     Float    // Totale maandwaarde
  totalASP        Float    // Totale ASP punten
  customerSavings Float    // Klant besparing
  
  // Commission calculation (auto-calculated)
  potentialCommission Float?  // Bij verstuurd
  effectiveCommission Float?  // Bij geaccepteerd
  
  // Status tracking
  status          String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, SOLD, REJECTED, EXPIRED
  sentAt          DateTime?
  acceptedAt      DateTime?
  soldAt          DateTime?
  activationDate  DateTime?
  
  // Clawback tracking
  clawbackStatus  String   @default("PENDING") // PENDING, PARTIAL, SECURED
  clawbackRisk    Float    @default(100) // 100 = high risk, 25 = medium, 0 = safe
  
  // Follow-up tracking
  followUpDone    Boolean  @default(false)
  followUpDate    DateTime?
  followUpQueued  Boolean  @default(false)
  
  // Communication
  emailSent       Boolean  @default(false)
  emailOpened     Boolean  @default(false)
  
  // PDF/Document
  pdfUrl          String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([consultantId])
  @@index([leadId])
  @@index([status])
  @@index([createdAt])
  @@map("offers")
}

// AUDIT LOG
model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String
  entityId    String
  oldValues   String?
  newValues   String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
